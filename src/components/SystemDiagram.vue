<template>
  <div class="system-diagram" @mousemove="moveNewArrow" @click="setRelationship">
    <diagram-arrow v-if="newRelationship" :from="newRelationship.from"
                   :to="newRelationship.to"></diagram-arrow>
    <div class="diagram-relationships">
      <diagram-relationship :relationship="relationship" v-for="relationship in relationships"
                            :key="relationship.id"></diagram-relationship>
    </div>
    <div class="diagram-items">
      <diagram-item :item="item" v-for="item in items" :key="item.id"></diagram-item>
    </div>
  </div>
</template>

<style lang="scss" scoped>

// Layout
.system-diagram {
  height: 100%;
  position: relative;
}

.diagram-items {
  height: 100%;
}

.diagram-item,
.diagram-relationship {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
}

.diagram-arrow {
  top: 0;
}

</style>

<script>
import DiagramArrow from '@/components/DiagramArrow'
import DiagramItem from '@/components/DiagramItem'
import DiagramRelationship from '@/components/DiagramRelationship'
import store from '@/store'

export default {
  name: 'system-diagram',
  props: {
    story: {
      type: Object
    }
  },
  data() {
    return {
      baseCoordinates: {x: 0, y: 0},
      mouseCoordinates: {x: 0, y: 0}
    }
  },
  components: {
    DiagramArrow,
    DiagramItem,
    DiagramRelationship
  },
  computed: {
    items() {
      return store.getters.diagramItemsFromStory(this.story)
    },
    relationships() {
      return store.getters.diagramRelationshipsFromStory(this.story)
    },
    newRelationship() {
      const newRelationship = store.getters.newDiagramRelationship
      if (typeof newRelationship === 'object' && newRelationship !== null && typeof newRelationship.from === 'object') {
        const arrow = Object.assign(newRelationship, {
          to: {
            x: this.mouseCoordinates.x - this.baseCoordinates.x,
            y: this.mouseCoordinates.y - this.baseCoordinates.y
          }
        })
        return arrow
      }
      return null
    }
  },
  mounted() {
    const box = this.$el.getBoundingClientRect()
    this.baseCoordinates = {x: box.left, y: box.top}
  },
  methods: {
    moveNewArrow(event) {
      if (store.getters.newDiagramRelationship) {
        this.mouseCoordinates = {
          x: event.x,
          y: event.y
        }
      }
    },
    setRelationship(event) {
      if (event.target.classList.contains('add-relationship-button')) {
        this.mouseCoordinates = {
          x: event.x,
          y: event.y
        }
      } else {
        store.dispatch('unsetNewDiagramRelationship')
      }
    }
  }
}

</script>
