<template>
  <div class="TopBar">
    <div class="left-items">
      <router-link :to="backUrl || '/'" class="link-back">
        <div class="BackIcon" v-if="backUrl"></div>
        <span class="PageTitle" v-if="title">{{ title }}</span>
        <span class="PageTitle" v-else-if="story">{{ story.title }}</span>
      </router-link>
    </div>
    <SuggestionsIndicator :number-of-suggestions="numberOfSuggestions"></SuggestionsIndicator>
    <div v-if="story"
         class="tooltip"
         @click="toggleComponents($event)"
         :class="{active: showComponents, warning: componentsMissing}"
    >
      <div class="Components"></div>
      <span class="tooltiptext">Components</span>
    </div>

    <div class="Divider" v-if="story"></div>

    <router-link :to="storyLink" class="tooltip" v-if="story">
      <div class="StoryIcon"></div>
      <span class="tooltiptext">Story</span>
    </router-link>

    <router-link :to="systemLink" class="tooltip" v-if="story">
      <div class="SystemIcon"></div>
      <span class="tooltiptext">System</span>
    </router-link>
  </div>
</template>

<style scoped lang="scss">
.TopBar {
  display: flex;
  flex-direction: row;
  background-color: white;
  border-bottom: 1px solid #c6c8c9;
  width: 100%;
  height: 64px;
  overflow: inherit;

  .BackIcon {
    width: 24px;
    height: 24px;
    background-image: url("../assets/icons/back.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-left: 16px;
    /* margin-right: 16px; */
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .Components {
    justify-content: flex-end;
    width: 24px;
    height: 24px;
    margin-left: 16px;
    margin-right: 16px;
    margin-top: 20px;
    margin-bottom: 20px;
    background-image: url("../assets/icons/components-idle.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }

  .tooltip.active .Components {
    background-image: url("../assets/icons/components-active.png");
  }
  .tooltip.warning {
    background-color: none;
    &:after {
      position: absolute;
      top: 10px;
      right: 7px;
      content: "";
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #db4141;
    }
  }

  .PageTitle {
    font-size: 20px;
    color: #031b26;
    line-height: 32px;
    vertical-align: middle;
    margin-top: 16px;
    margin-bottom: 16px;
    margin-left: 16px;
  }

  .StoryIcon {
    justify-content: flex-end;
    width: 24px;
    height: 24px;
    margin: auto;
    background-image: url("../assets/icons/story-idle.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-left: 16px;
    margin-right: 16px;
    margin-top: 20px;
    margin-bottom: 20px;
  }
  .tooltip.router-link-active .StoryIcon {
    background-image: url("../assets/icons/story-active.png");
  }

  .SystemIcon {
    justify-content: flex-end;
    width: 24px;
    height: 24px;
    margin: auto;
    background-image: url("../assets/icons/system-idle.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-left: 16px;
    margin-right: 16px;
    margin-top: 20px;
    margin-bottom: 20px;
  }
  .tooltip.router-link-active .SystemIcon {
    background-image: url("../assets/icons/system-active.png");
  }

  .Divider {
    justify-content: flex-end;
    width: 1px;
    height: 24px;
    margin: auto;
    background-image: url("../assets/icons/divider.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-left: 4px;
    margin-right: 4px;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  /* Tooltip container */
  .tooltip {
    position: relative;
    display: inline-block;
    z-index: 40;
  }

  /* Tooltip text */
  .tooltip .tooltiptext {
    visibility: hidden;
    width: 120px;
    margin-left: -32px;
    background-color: #707679;
    color: #fff;
    font-weight: 200;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;

    /* Position the tooltip text - see examples below! */
    position: absolute;
    z-index: 1;
  }

  /* Show the tooltip text when you mouse over the tooltip container */
  .tooltip:not(.active):hover .tooltiptext {
    visibility: visible;
  }

  .tooltip .tooltiptext::after {
    content: " ";
    position: absolute;
    bottom: 100%; /* At the top of the tooltip */
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #707679 transparent;
  }

  .left-items {
    display: flex;
    flex-grow: 1;
  }

  .link-back {
    display: flex;
    &:not(:hover) {
      text-decoration: none;
    }
  }
}
</style>

<script>
import store from "@/store";
import SuggestionsIndicator from "@/components/SuggestionsIndicator";

export default {
  name: "top-bar",
  components: {SuggestionsIndicator},
  props: {
    backUrl: {
      type: String
    },
    numberOfSuggestions: {
      type: Number,
      default: 0
    },
    story: {
      type: Object
    },
    title: {
      type: String
    }
  },
  computed: {
    componentsMissing() {
      return this.story && store.getters.componentsMissing(this.story);
    },
    showComponents() {
      return store.getters.showComponents;
    },
    storyLink() {
      if (this.story) {
        return '/story/' + this.story.id
      }
      return '#'
    },
    systemLink() {
      if (this.story) {
        return '/system/' + this.story.id
      }
      return '#'
    }
  },
  methods: {
    toggleComponents(event) {
      // Use preventDefault and stopPropagation
      // to avoid losing the text selection if the smart text field is focused.
      // https://stackoverflow.com/a/20759988
      if (store.getters.focusedElement === 'smartText') {
        event.preventDefault()
        // We need stopPropagation as well because clicking on the outer frame
        // also has side effects.
        event.stopPropagation()
        store.dispatch('setFocus', 'componentsToggle')
      }
      store.dispatch("toggleComponents");
    }
  }
};
</script>

<docs>
  ```jsx
  <top-bar :number-of-suggestions="2" :story="{title: 'Story Title'}"></top-bar>
  ```
</docs>
